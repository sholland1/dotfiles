#!/bin/bash
cpu() {
  # get the difference between the current and previous idle and total CPU time
  idle_diff=$((${3:-0} - ${1:-0}))
  total_diff=$((${4:-0} - ${2:-0}))

  if [ "$total_diff" -eq 0 ]; then
    echo -n "⏳0%"
    return
  fi

  # calculate the percentage
  PERC=$(awk "BEGIN { printf \"%.0f\", (100 * ($total_diff - $idle_diff) / $total_diff) }")

  # print the percentage
  echo -n "⏳${PERC}%"
}

getdate() {
  date +'%m/%d/%Y %I:%M %p'
}

volume() {
  AMIXER_OUTPUT=$(amixer get Master)

  if [[ "$AMIXER_OUTPUT" == *"[off]"* ]]; then
    echo -n '🔇[M]'
    return
  fi

  VOL=$(echo "$AMIXER_OUTPUT" | grep -oE '[0-9]+%' | sed 's/%//' | tail -1)
  ICON=🔈
  if [ "$VOL" -gt 75 ]; then
    ICON=🔊
  elif [ "$VOL" -gt 50 ]; then
    ICON=🔉
  fi
  echo -n "$ICON[$VOL%]"
}

mem() {
  free | awk '/^Mem/{printf "🧮 %.2fG/%.1fG", ($3+$5)/1024/1024, $2/1024/1024}'
}

disk() {
  df | awk '/\/$/{printf "💽 %.2fG/%.0fG", $3/1024/1024, $2/1024/1024}'
}

up() {
  uptime -p |
    sed -r 's/ ([a-z])[a-z]*,?/\1/g;s/^up/⬆/'
}

music() {
  progress=$(mpc | awk '/^\[/{print($1~/\[pa.*\]/?" ":" ")$3}')
  track=$(mpc current -f '%title% - %artist%')
  if [ "$track" = ' - ' ]; then
    msg="$progress"
  else
    msg="$progress - $track"
  fi
  [ -z "$progress" ] && [ -z "$track" ] || echo -n "$msg :: "
}

lastUpdate() {
  grep -F '[PACMAN] starting full system' /var/log/pacman.log |
    awk -F'[][]' 'END{print $2}' |
    xargs date +'🔄 %m/%d/%Y' -d
}

record_status() {
  if [ "$(cat "$HOME/.cache/.recording")" = "1" ]; then
    echo -n "🔴- Recording :: "
  fi
}

echo -n " $(record_status)$(lastUpdate) :: $(up) :: $(cpu "$1" "$2" "$3" "$4") :: $(disk) :: $(mem) :: $(volume) :: $(getdate)"
